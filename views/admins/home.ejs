<% include ../shared/admin_navbar %>
<div class = "message-field-success uk-alert uk-alert-success"></div>
<div class = "message-field-fail uk-alert uk-alert-danger"></div>

<div class = "uk-grid">
	<div class = "uk-width-1-3">
		<div class = "uk-pannel uk-panel-box uk-panel-box-secondary">
			<h3 class = "uk-panel-title">Next Appointment for each Client</h3>
			<% for (var i = 0; i < dashboard.clientTimes.length; i++) { %>
				<div><p><%= dashboard.clientTimes[i].client_name + " " + dashboard.clientTimes[i].appointment_date +
					" " + dashboard.clientTimes[i].start_time + " - " + dashboard.clientTimes[i].end_time%></p><a href="mailto:<%= dashboard.clientTimes[i].client_email %>" class="uk-button uk-button-primary">Email</a>
				</div>
			<% } %>
		</div>
	</div>

	<div class = "uk-width-1-3">
		<div class = "uk-panel uk-panel-box uk-panel-box-secondary">
			<div class = "day-calendar"></div>
		</div>
	</div>

	<div class = "uk-width-1-3">
		<div class = "uk-panel uk-panel-box uk-panel-box-secondary">
			<h3 class = "uk-panel-title"> Appointments needing confirmation</h3>
			<% if(dashboard.appointmentConfirms.length > 0){ %>
				<% for (var i = 0; i < dashboard.appointmentConfirms.length; i++) { %>
					<div><p><%= dashboard.appointmentConfirms[i].client_name + " " + dashboard.appointmentConfirms[i].appointment_date +
						" " + dashboard.appointmentConfirms[i].start_time + " - " + dashboard.appointmentConfirms[i].end_time%></p>

						<button value="<%=dashboard.appointmentConfirms[i].appointment_id %>", class="uk-button uk-button-primary confirm-yes confirmer"> Confirm,Yes?</button>
						<button value="<%=dashboard.appointmentConfirms[i].appointment_id %>"	, class="uk-button uk-button-danger confirm-no confirmer"> Confirm, No?</button>
					</div>
				<% } %>
			<% } else { %>
				<div><p>No Appointments Need Confirmation</p></div>
			<% } %>
		</div>
	</div>

</div>









<script>
	$(function(){

		// set global variable for date
		 var date = new Date();
		 var dailyTimes = {};


		 // initial calendar

		 
		// Listeners on Page

		$(".confirm-no").on('click',function(e){
			e.preventDefault;
			$('.confirmer').attr('disabled',true);
			var buttonClicked = this;
			var apptId = $(this).val();
			declineAppointment(apptId,buttonClicked,handleResponse);
		});

		$(".confirm-yes").on('click',function(e){
			e.preventDefault;
			$('.confirmer').attr('disabled',true);
			var buttonClicked = this;
			var apptId = $(this).val();
			acceptAppointment(apptId,buttonClicked,handleResponse);
		});

	function setNextButton(){
		$(".fc-button-next").on('click',function(){
				moveForwardDay();
		});
	}

	function setPrevButton(){
		$(".fc-button-prev").on('click',function(){
			moveBackDay();
		});
	}

	function setTodayButton(){
		$(".fc-button-today").on('click',function(){
			resetDate();
		});
	}
	// Ajax request to fill calendar info

	function fillEvents(niceDate){
		$.post('/dailyschedule',{dateToInquiry:niceDate} ,function(data){
				var dailyTimes = $.map(data.times, function(session){ //deal with error of not being able to display calendar 
					// when no appointments are available.
					console.log(session)
					return {
				 						id : session.appointment_id,
				 						start : prettifyDate(session.appointment_date)+ " " + session.start_time,
				 						end : prettifyDate(session.appointment_date)+ " " + session.end_time,
				 						title : session.client_name == null ? "Open Slot" : session.client_name,
				 						allDay : false
		 						}
				})
					$(".day-calendar").fullCalendar({
						defaultView:'agendaDay',
		 				events: dailyTimes
					});
				console.log(date);
				console.log(dailyTimes);
			// setNextButton();
			// setPrevButton();
			// setTodayButton();  //change these to switch statement and only have one 
			});
		};		


	function prettifyDate(date){
			var formattedDate = date.match(/^(\d{4}-\d\d-\d\d)/);
		 return formattedDate[1]
	  }		
	
	//helper functions

	function moveForwardDay(){
		date.setDate(date.getDate() + 1)
		sendDate(date);
	}

	function moveBackDay(){
		date.setDate(date.getDate() - 1)
		sendDate(date)
	}

	function resetDate(){
		date = new Date();
		sendDate(date);
	}

	function sendDate(date){
		var sendableDate = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
		console.log(sendableDate);

		fillEvents(sendableDate);
	}


	function declineAppointment(apptId,buttonClicked,cb){
		$.post('/decline-appointment',{data:apptId},function(data){
			if(data){
				cb(data);
			}
			cb(null,buttonClicked);
		});
	}

	function acceptAppointment(apptId,buttonClicked,cb){
		$.post('/accept-appointment',{data:apptId},function(data){
			if(data){
				cb(data);
			}
			cb(null,buttonClicked);
		})
	}

	var handleResponse = function(err,updated){
		if(err){
			$('.message-field-fail').html(err.message).show();
			$('.confirmer').attr('disabled',false);
		} else{
			$('.message-field-success').html("Confirmed").show();
			$(updated).parent().hide();
			$('.confirmer').attr('disabled',false);
		}
	}

	resetDate();

	
 });
</script>